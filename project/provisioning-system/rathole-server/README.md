# Rathole Server Setup

This directory contains the configuration and deployment files for the Rathole tunnel server that provides public access to Satisfactory game servers.

## Architecture

- **Rathole Server**: Core tunneling service that accepts connections from clients
- **Control API**: HTTP API for dynamically managing tunnels
- **Docker Compose**: Complete deployment stack

## Configuration

### Security Tokens

Before deploying, update the following tokens in your configuration files:

1. **rathole-server.toml**:
   - `default_token`: Main authentication token for clients
   - `server.control.token`: API control token

2. **docker-compose.yml**:
   - `API_TOKEN`: Environment variable for the API service

3. **Generate secure tokens**:
   ```bash
   # Generate random tokens
   openssl rand -hex 32  # For default_token
   openssl rand -hex 32  # For control token
   ```

### Port Configuration

- **2333**: Main Rathole server port (for client connections)
- **7000**: Control API port (for tunnel management)
- **7001**: Optional separate API service port
- **15000-16000/udp**: Port range for Satisfactory game servers

## Deployment

### Local Development

1. Update tokens in configuration files
2. Start the services:
   ```bash
   docker-compose up -d
   ```

### Production Deployment

1. **Security Hardening**:
   - Enable TLS in `rathole-server.toml`
   - Use environment variables for sensitive tokens
   - Restrict network access to control API

2. **TLS Configuration** (recommended):
   ```toml
   [server.transport.tls]
   pkcs12 = "/path/to/cert.p12"
   pkcs12_password = "your_cert_password"
   ```

3. **Environment Variables**:
   ```bash
   export RATHOLE_DEFAULT_TOKEN="your-secure-token"
   export RATHOLE_CONTROL_TOKEN="your-control-token"
   ```

## API Endpoints

The control API provides the following endpoints:

### Add Tunnel
```http
POST /api/tunnels/add
Content-Type: application/json

{
  "id": "server123_game",
  "bind_addr": "0.0.0.0:15001",
  "target_addr": "10.0.1.100:7777",
  "token": "your-api-token"
}
```

### Remove Tunnel
```http
POST /api/tunnels/remove
Content-Type: application/json

{
  "id": "server123_game",
  "token": "your-api-token"
}
```

### List Tunnels
```http
GET /api/tunnels?token=your-api-token
```

### Health Check
```http
GET /health
```

## Integration with Orchestrator

The Spring Boot orchestrator uses the `RatholeService` to communicate with this API:

```java
// Configure tunnels for a new server
ratholeService.createTunnel(
    serverId + "_game",
    "0.0.0.0:" + gamePort,
    nodeIp + ":" + gamePort
);
```

## Monitoring

### Logs
- Rathole server logs: `/var/log/rathole/server.log`
- API logs: Docker container logs

### Health Checks
```bash
# Check Rathole server
nc -z localhost 2333

# Check API service
curl http://localhost:7001/health
```

## Troubleshooting

### Common Issues

1. **Connection Refused**:
   - Check if ports are open in firewall
   - Verify Docker containers are running

2. **Authentication Errors**:
   - Verify tokens match between configuration files
   - Check token format (should be hex string)

3. **Tunnel Creation Fails**:
   - Check target server is reachable
   - Verify port ranges don't conflict

### Debug Commands

```bash
# View container logs
docker-compose logs rathole-server
docker-compose logs rathole-api

# Test API connectivity
curl -X GET "http://localhost:7001/api/tunnels?token=your-token"

# Check port bindings
netstat -tulpn | grep -E "(2333|7000|7001)"
```

## Client Configuration

Game server nodes need Rathole clients configured to connect back to this server. The client configuration is managed by the host agent on each node.

Example client configuration (generated by host agent):
```toml
[client]
remote_addr = "your-rathole-server.com:2333"
default_token = "your-secure-token"

[client.services.server123_game]
type = "udp"
local_addr = "127.0.0.1:7777"
remote_addr = "0.0.0.0:15001"
```
